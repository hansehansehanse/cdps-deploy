{% extends 'admin_base_graph.html' %}

{% block content %}
<div class="container-xxl flex-grow-1 container-p-y">
  <h4 class="fw-bold py-3 mb-4">
    <span class="text-muted fw-light">Dataset /</span> Commuter Chart
  </h4>

  <div class="row">
    <div class="col-12">
      <!-- <h5 class="card-header">Dataset /</span> Commuter Chart</h5> -->
      <div class="card-body" data-select2-id="47">
        <div class="row" data-select2-id="46">
          
          <div class="row">
            
            <!-- Date Picker -->
            <div class="col-md-4 mb-4">
              <label for="datePicker" class="form-label">Select Date:</label>
              <div class="input-group">
                <input type="date" id="datePicker" class="form-control form-control-lg">
                <button type="button" class="btn btn-outline-primary" onclick="setToday()">Today</button>
              </div>
            </div>

            <div class="col-md-4 mb-4">
              <label for="route" class="form-label">Select Route:</label>
              <div class="position-relative">
                <select id="route" class="select2 form-select form-select-lg" data-allow-clear="true" onchange="updateTimeOptions()">
                  <option value="">Select Route</option>
                  <option value="A to B" {% if route == 'A to B' %}selected{% endif %}>A to B</option>
                  <option value="A to C" {% if route == 'A to C' %}selected{% endif %}>A to C</option>
                </select>
              </div>
            </div>
            
          
            <div class="col-md-4 mb-4">
              <label for="time" class="form-label">Select Time:</label>
              <div class="position-relative">
                <select id="time" class="select2 form-select form-select-lg" data-allow-clear="true">
                  <option value="">Select Time</option>
                  <!-- Time options will be dynamically populated via JavaScript -->
                </select>
              </div>
            </div>
            
          </div>
          


        </div>

      </div>

    </div>

    <div class="col-lg-3 col-sm-6 mb-4">
      <div class="card h-100">
        <div class="card-body d-flex justify-content-between align-items-center">
          <div>
            <h5 class="mb-0 me-2" id="avgCommutersValue">--</h5>

            <small class="text-muted" id="avgCommutersLabel">Average Commuters</small>
          </div>
          <span class="badge bg-label-success rounded-pill p-2">
            <i class="ti ti-users ti-sm"></i>
          </span>
        </div>
      </div>
    </div>  

    <div class="col-lg-3 col-sm-6 mb-4">
      <div class="card h-100">
        <div class="card-body d-flex justify-content-between align-items-center">
          <div>
            <h5 class="mb-0 me-2" id="rfPredictionValue">--</h5>

            <small class="text-muted" id="rfPredictionLabel">Random Forest</small>
          </div>
          <span class="badge bg-label-success rounded-pill p-2">
            <i class="ti ti-users ti-sm"></i>
          </span>
        </div>
      </div>
    </div>  


    <div class="col-12 mb-4">
      <div class="card">
        <div class="card-header d-flex justify-content-between"></div>
            <h5 class="card-header">Historical Commuter Count (Last 7 Instances Based on Current Filter)</h5>  
            <div id="chart1">           
            </div>
      </div>
      <div class="card p-3"></div>
    </div>



  </row>



  



  <!-- Script for AJAX and Line Chart -->
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>


<!-- Scipt  -->
   <script>

    //Calendar Today
    function setToday() {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('datePicker').value = today;
    }
    //!Calendar Today


 
    let selectedRoute = '';
    let selectedTime = '';
    let selectedDate = '';

    // Add event listeners
    document.getElementById('route').addEventListener('change', updateSelection);
    document.getElementById('time').addEventListener('change', updateSelection);
    document.getElementById('datePicker').addEventListener('change', updateSelection);


    // Average Commuter Count
    function updateSelection() {
    selectedRoute = document.getElementById('route').value;
    selectedTime = document.getElementById('time').value;
    selectedDate = document.getElementById('datePicker').value;

    if (selectedRoute && selectedTime && selectedDate) {
        console.log(`Selected Route: ${selectedRoute}`);
        console.log(`Selected Time: ${selectedTime}`);
        console.log(`Selected Date: ${selectedDate}`);

        $.ajax({
            url: "{% url 'dataset_graph' %}",
            type: "POST",
            data: {
                graph_type: "average_from_date",
                route: selectedRoute,
                time: selectedTime,
                date: selectedDate,
                csrfmiddlewaretoken: '{{ csrf_token }}',
            },
            success: function (response) {
                console.log("Successful Average Commuter Count");
                
                document.getElementById("avgCommutersValue").textContent = response.average ?? "--";
                
            },

            error: () => {
                // console.log("no");
                alert("Error!");
            }
        });

         //Random Forest Prediction
        $.ajax({
            url: "{% url 'dataset_graph' %}",
            type: "POST",
            data: {
                graph_type: "rf_prediction",
                route: selectedRoute,
                time: selectedTime,
                date: selectedDate,
                csrfmiddlewaretoken: '{{ csrf_token }}',
            },
            success: function (response) {
                console.log("rfPredictionValue: " + response.prediction);
              
                document.getElementById("rfPredictionValue").textContent = response.prediction ?? "--";

                
            },

            error: () => {
                // console.log("no");
                alert("Error!");
            }
        });
        // console.log("AJAX request sent for average commuter count.");
        }
    }

    //!Average Commuter Count
   

    //Bar Graph
    const routeTimes = {
      "A to B": ["5:00AM", "1:00PM", "6:00PM"],
      "A to C": ["5:30AM"]
    };
  
    let lastSelectedRoute = "";
    let lastSelectedTime = "";
  
    // function updateChart() {
    //   if (lastSelectedRoute && lastSelectedTime) {
    //     $.ajax({
    //       url: "{% url 'dataset_graph' %}",
    //       type: "POST",
    //       data: {
    //         'route': lastSelectedRoute,
    //         'time': lastSelectedTime,
    //         'csrfmiddlewaretoken': '{{ csrf_token }}',
    //       },
    //       success: function (response) {
    //         const data = JSON.parse(response.chart_data);
    //         const chartElement = document.querySelector("#chart1");
    //         chartElement.innerHTML = "";
    //         const chart = new ApexCharts(chartElement, {
    //           chart: { type: 'line', height: 350 },
    //           series: [{ name: `${lastSelectedRoute} (${lastSelectedTime})`, data: data.num_commuters }],
    //           xaxis: { categories: data.dates },
    //           title: { text: `${lastSelectedRoute} - ${lastSelectedTime} Commuter Trend`, align: 'center' }       //! title
    //         });
    //         chart.render();
    //       },
    //       error: () => alert("Error fetching data")
    //     });
    //   }
    // }
  
    function updateChart() {
      if (lastSelectedRoute && lastSelectedTime) {
        $.ajax({
          url: "{% url 'dataset_graph' %}",
          type: "POST",
          data: {
            'graph_type': 'last7',  // Tell backend which graph you want
            'route': lastSelectedRoute,
            'time': lastSelectedTime,
            'csrfmiddlewaretoken': '{{ csrf_token }}',
          },
          success: function (response) {
            const data = JSON.parse(response.chart_data);
            const chartElement = document.querySelector("#chart1");
            chartElement.innerHTML = "";
            const chart = new ApexCharts(chartElement, {
              chart: { type: 'line', height: 350 },
              series: [{ name: `${lastSelectedRoute} (${lastSelectedTime})`, data: data.num_commuters }],
              xaxis: { categories: data.dates },
              title: { text: `${lastSelectedRoute} - ${lastSelectedTime} (Last 7 Records)`, align: 'center' }
            });
            chart.render();
          },
          error: () => alert("Error fetching data")
        });
      }
    }


    function updateTimeOptions() {
      const routeSelect = document.getElementById('route');
      const timeSelect = document.getElementById('time');
      const route = routeSelect.value;
      lastSelectedRoute = route;
      lastSelectedTime = "";
  
      timeSelect.innerHTML = '<option value="">Select Time</option>';
      if (route && routeTimes[route]) {
        routeTimes[route].forEach(time => {
          const opt = document.createElement("option");
          opt.value = time;
          opt.textContent = time;
          timeSelect.appendChild(opt);
        });
      }
  
      updateChart();
    }
  
    document.getElementById('route').addEventListener('change', updateTimeOptions);
    document.getElementById('time').addEventListener('change', function () {
      lastSelectedTime = this.value;
      updateChart();
    });


    // Initialize chart with default zero values (for 7 days)
    function initializeEmptyChart() {
      const chartElement = document.querySelector("#chart1");
      chartElement.innerHTML = "";

      const defaultDates = ["Day 1", "Day 2", "Day 3", "Day 4", "Day 5", "Day 6", "Day 7"];
      const zeroData = [0, 0, 0, 0, 0, 0, 0];

      const chart = new ApexCharts(chartElement, {
        chart: { type: 'line', height: 350 },
        series: [{ name: "No Data", data: zeroData }],
        xaxis: { categories: defaultDates },
        title: { text: "Commuter Trend (No Filter Selected)", align: 'center' }
      });

      chart.render();
    }
  
    window.onload = function () {
      initializeEmptyChart();  // <- Add this line
      updateTimeOptions();
    };





    //Random Forest Prediction



  </script>
<!-- Scipt  -->

</div>
{% endblock %}
